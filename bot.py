import os
import json
import asyncio
import aiohttp
import logging
from datetime import datetime

# Configuration
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN', '')
TELEGRAM_CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID', '')
STEAM_API_KEY = os.environ.get('STEAM_API_KEY', '')

STEAM_ACCOUNTS = [

    
    


     '76561197965887022', '76561198000527103', '76561198000350115', '76561198000317465', '76561198000112610',
    '76561198000346658', '76561198000666480', '76561198000233919', '76561198000641859', '76561198000122834',
    '76561198000381123', '76561198000017785', '76561198000381569', '76561198001243229', '76561198000222769',
    '76561198001096656', '76561198000145061', '76561198000092640', '76561198000200319', '76561198000392414',
    '76561198000497024', '76561198000147607', '76561198000588241', '76561198000275531', '76561198000665074',
    '76561198001095637', '76561198000051616', '76561198000019232', '76561198000317427', '76561198000670804',
    '76561198000142268', '76561198000421152', '76561198000599798', '76561198000170527', '76561198000200339',
    '76561198000855004', '76561198000433971', '76561198000472318', '76561198000222769', '76561198001085707',
    '76561198000947701', '76561198000094658', '76561198000450904', '76561198000273292', '76561198000200319',
    '76561198000392414', '76561198000435559', '76561198007665565', '76561198001404831', '76561198000833864',
    '76561198000057961', '76561198001006230', '76561198001258100', '76561198000729060', '76561198000248499',
    '76561198001193681', '76561198000443501', '76561198000149540', '76561198000165483', '76561198000836157',
    '76561197994318050', '76561198000416419', '76561198000112610', '76561198001014783', '76561198000171764',
    '76561198000834227', '76561198001231789', '76561198000527077', '76561198000075771', '76561198021441979',
    '76561198000479873', '76561198001364407', '76561197995627338', '76561198000961550', '76561198001252369',
    '76561198001013228', '76561198001155655', '76561198000001745', '76561198001017873', '76561198000171119',
    '76561198000394726', '76561198000109103', '76561198000422338', '76561198000081676', '76561198000272446',
    '76561198000817933', '76561198001029745', '76561198000047107', '76561198001361378', '76561198000495685',
    '76561198000181221', '76561198000094888', '76561197995143376', '76561198000256526', '76561198000234290',
    '76561198001505790', '76561198000897514', '76561198000527077', '76561198000075771', '76561198000479873',
    '76561198021441979', '76561198001013228', '76561198001155655', '76561197995627338', '76561198001364407',
    '76561198001252369', '76561198000400357', '76561198000001745', '76561198000486229', '76561198001054704',
    '76561198000094888', '76561198000491525', '76561198000597542', '76561198000189570', '76561197996481571',
    '76561198000433971', '76561198000435559', '76561198000017785', '76561198000472318', '76561198063084333',
    '76561198008206642', '76561198052601872', '76561198000157611', '76561198071715663', '76561198000061461',
    '76561198024594453', '76561198052719500', '76561198002640314', '76561198104500554', '76561198045771859',
    '76561198019550613', '76561198027544330', '76561198072734050','76561197996481571', '76561198000192501',
    '76561198019550613', '76561198076313031', '76561198024594453', '76561198104500554', '76561198049371496',
    '76561198065963039',  '76561198149439931', '76561198127873209', '76561198142130862','76561199500756085',
    '76561199496956238', '76561199500385048', '76561199500951926', '76561199500005325', '76561199497630452',
    '76561199498924543', '76561199497771613', '76561199500235282', '76561199500014125', '76561199501108116',
    '76561199498423193', '76561199499123587', '76561199497261606', '76561199498470139', '76561199499571033',
    '76561199497679384', '76561199501673003', '76561199500608022', '76561199496691162', '76561199501104834',
    '76561199500895783', '76561199497793720', '76561199497377892', '76561199497453565', '76561199500706951',
    '76561199497445160', '76561199498398617', '76561199499442187', '76561199498788747', '76561199500875943',
    '76561199497646670', '76561199499468248', '76561199499806759', '76561199496946365', '76561199497571158',
    '76561199496101725', '76561199499519870', '76561199499143473', '76561199497306656', '76561199499527896',
    '76561199499973463', '76561199498606151', '76561199499051646', '76561199497621400', '76561199501817093',
    '76561199498860339', '76561199500034242', '76561199499701429', '76561199498102714', '76561199500347375',
    '76561199497144571', '76561199501332923', '76561199501970739', '76561199496816668', '76561199497870067',
    '76561199497202822', '76561199499920017', '76561199499986754', '76561199497717386', '76561199498519237',
    '76561199500235282', '76561199500005325', '76561199500014125', '76561199499318862', '76561199499095987',
    '76561199500495187', '76561199500791507', '76561199500701068', '76561199500559026', '76561199499224652',
    '76561199501791099', '76561199497089139', '76561199500835486', '76561199497338900', '76561199500317903',
    '76561199497648837', '76561199497443223', '76561199497350485', '76561199498554026', '76561199499220988',
    '76561199498554026', '76561199497338900', '76561199500363541', '76561199501535446', '76561199497772839',
    '76561199499306998', '76561199497261451', '76561199500026923', '76561199497793479', '76561199500487491',
    '76561199499229066', '76561199499192502', '76561199500554147', '76561199498932376', '76561199497274874',
    '76561199500070422', '76561199497354574', '76561199499250336', '76561199498450852', '76561199497270025',
    '76561199497772839', '76561199500786284', '76561199499306998', '76561199497793479', '76561199500026923',
    '76561199498898187', '76561199499192502', '76561199500645174', '76561199501008761', '76561199496895853',
    '76561199499347925', '76561199498280144', '76561199499340002', '76561199499200960', '76561199500376092',
    '76561199497323929', '76561199498601722', '76561199500610424', '76561199498608193', '76561199500182563',
    '76561199500721656', '76561199501380866', '76561199497273486', '76561199501008761', '76561199499340002',
    '76561199499347925', '76561199496895853', '76561199500487491', '76561199499192502', '76561199499530049',
    '76561199499229066', '76561199498974838', '76561199498866902', '76561199500083664', '76561199501383867',
    '76561199501633484', '76561199499612234', '76561199499758882', '76561199498828211', '76561199500448713',
    '76561199500640844', '76561199498377090', '76561199501030648', '76561199500207769', '76561199499006192',
    '76561199499218092', '76561199500771583', '76561199500233672', '76561199500236447', '76561199497323929',
    '76561199500610424', '76561199498608193', '76561199499611436', '76561199497270945', '76561199501447657',
    '76561199501380866', '76561199501008761', '76561199496895853', '76561199499347925', '76561199499340002',
    '76561199499168875', '76561199499387704', '76561199496657934', '76561199499541874', '76561199499322871',
    '76561199501202649', '76561199499083439', '76561199499347925', '76561199496895853', '76561199499464211',
    '76561199499699940', '76561199500217656', '76561199500038538', '76561199501779086', '76561199501008761',
    '76561199498560340', '76561199497839534', '76561199498936154', '76561199499824115', '76561199500215674',
    '76561199501089789', '76561199500880036', '76561199498936154', '76561199499168875', '76561199499245881',
    '76561199497449501', '76561199500912531', '76561199499861718', '76561199500164928', '76561199500217656',
    '76561199499699940', '76561199499238544', '76561199497839534', '76561199499387704', '76561199499019276',
    '76561199497732353', '76561199498566802', '76561199498007984', '76561199500896979', '76561199498953404',
    '76561199498953404', '76561199499045176', '76561199500896979', '76561199498670904', '76561199501572387',
    '76561199500214802', '76561199499608302', '76561199500342803', '76561199498870473', '76561199500256552',
    '76561199501334108', '76561199497232433', '76561199500431106', '76561199500841345', '76561198856349849',
    '76561199497897825', '76561199499080963', '76561199500977732', '76561199500748189', '76561199499498206',
    '76561199500740788', '76561199499622497', '76561199499008446', '76561199497753975', '76561199500977732',
    '76561199499204620', '76561199499075938', '76561199496614567', '76561199497914029', '76561199500893150',
    '76561199500109370', '76561199499923383', '76561199498779660', '76561199497079770', '76561199496931506',
    '76561199500389668', '76561199497008153', '76561199496790009', '76561199497448045', '76561199497243851',
    '76561199498571379', '76561199498837842', '76561199499368999', '76561199497160281','76561199498546171',
    '76561199498849973', '76561199499529258', '76561199500604696', '76561199497855443', '76561199496804007',
    '76561199497080808', '76561199500349619', '76561199500339074', '76561199497245119', '76561199497629131',
    '76561199497370627', '76561199499342462', '76561199501298238', '76561199500334671', '76561199497656586',
    '76561199497243851', '76561199499342462', '76561199500335798', '76561199497079770', '76561199499720980',
    '76561199500522486', '76561199501275292', '76561199500358828', '76561199497370627', '76561199498032281', 
    '76561199497087949', '76561199500119174', '76561199497861878', '76561199497648853', '76561199500070290',
    '76561199497648853', '76561199497087949', '76561199497861878', '76561199500053309', '76561199496807975',
    '76561199500407098', '76561199500351627', '76561199500991771', '76561199498704650', '76561199499347812',
    '76561199500706494', '76561199501183416', '76561199499728534', '76561199500538865', '76561199499826108',
    '76561199499249383', '76561199498881605', '76561199500226112', '76561199498790735', '76561199500484970',
    '76561199073840216', '76561199446850745', '76561199071805897', '76561199127579739', '76561199447585254',
    '76561199447791780', '76561199447752096', '76561199063773061', '76561199082431675', '76561199180414541',
    '76561199179183795', '76561199447692830', '76561199447583464', '76561199127564783', '76561199393508146',
    '76561199185442868', '76561199392568151', '76561199166664603', '76561199160804951', '76561199392348240',
    '76561199156779371', '76561199406756245', '76561199146075665', '76561199163707302', '76561199142770964',
    '76561199261728421', '76561199189889763', '76561199190661111', '76561199186491618', '76561199166068161',
    '76561199189589508', '76561199186515919', '76561199393020093', '76561199373020317','76561199447246262', 
    '76561199447271554', '76561199447564881', '76561199447108186', '76561199447847344', '76561199447524998',
    '76561199422645891', '76561199545283028','76561199447164685', '76561199447352359', '76561199446890754',
    '76561199447041143', '76561199447007133', '76561199447512544', '76561199447860883', '76561199176857880',
    '76561199447869650', '76561199161241262', '76561199447838005', '76561199183934448', '76561199447479412',
    '76561199447665237', '76561199447165667', '76561199447540046', '76561199180209178', '76561199392075472',
    '76561199184563746', '76561199128523023', '76561199406559905', '76561199392476118', '76561199184753261',
     '76561199447368883', '76561199161089289', '76561199404341995', '76561199447473176','76561199183283568',
    '76561199447473176', '76561199404341995', '76561199404406086', '76561199447653322', '76561199403928313',
    '76561199183441892', '76561199404230685', '76561199160915061', '76561199179504870', '76561199182899741',
    '76561199403802673', '76561199167766432', '76561199404188389', '76561199181783172', '76561199177718525',
    '76561199135095963', '76561198989889733', '76561199144868791', '76561199147214492', '76561199046202647',
    '76561199403924116', '76561199447608103', '76561199144868791', '76561199179671103', '76561199183186544',
    '76561199448158272', '76561199181700867', '76561199147024861', '76561199181830325', '76561199177670484',
    '76561199060193197', '76561199009531290', '76561199448216633', '76561199058306180', '76561199144400540',
    '76561199177160685', '76561199173349273', '76561199182120101', '76561199447301806', '76561199137286588',
    '76561199137286588', '76561199194434622', '76561199195114832', '76561199436282432', '76561199392770658',
    '76561199436172209', '76561199393383858', '76561199151420856', '76561199389192040', '76561199394044349',
    '76561199394228610', '76561199436085373', '76561199435210759', '76561199392303889', '76561199028025142',
    '76561199025450937', '76561199435978734', '76561199171895116', '76561199192223955', '76561199405055052',
    '76561199025450937', '76561199392303889', '76561199435978734', '76561199080463759', '76561199152325228',
    '76561199167578548', '76561199017423705', '76561199393491382', '76561199054401023', '76561199185382284',
    '76561199144701820', '76561199127505083', '76561199192096622', '76561199145388188', '76561199435110962',
    '76561199192239305', '76561199149987147', '76561199434919343', '76561199392311270', '76561199193825874',
    '76561199108226472', '76561199126569425', '76561199434919343', '76561199149987147', '76561199435110962',
    '76561199192239305', '76561199076736501', '76561199193825874', '76561199192096622', '76561199127579739',
    '76561199164588480', '76561199144701820', '76561199127505083', '76561199054401023', '76561199192565913',
    '76561199185382284', '76561199145388188', '76561199193926936', '76561199245820291', '76561199435107628',
    '76561199446885911', '76561199447317385', '76561199447681087', '76561199155857122', '76561199180414541',
    '76561199393557172', '76561199019014022', '76561199394141115', '76561199107744742', '76561199056149568',
    '76561199155704206', '76561199186104042', '76561199063537933', '76561199107256521', '76561199054790736',
    '76561199056480631', '76561199189902086', '76561199422842708', '76561199195464654', '76561199192356098',
    '76561199056480631', '76561199189902086', '76561199107256521', '76561199190328502', '76561199145070797',
    '76561198988469971', '76561199154360031', '76561199545294568', '76561199404655593', '76561199421969381',
    '76561199447225538', '76561199404521493', '76561199447517162', '76561199447688363','76561199447482330',
    '76561199447673013', '76561199447911055', '76561199446906571', '76561199447518426', '76561199447408388',
    '76561199447481403', '76561199447734780', '76561199447918609', '76561199404043862','76561199406599100',
    '76561199404043862', '76561199447734780', '76561199447481403', '76561199180216923', '76561199158653074',
    '76561199447848384', '76561199137407821', '76561199447841635', '76561199447225246','76561199447420692',
    '76561199081564060', '76561199171898062', '76561199002047377','76561199446886013', '76561199447508314', 
    '76561199420232033', '76561199417210775', '76561199544487034', '76561199545461158','76561199545462204',
    '76561199544487034', '76561199447467553', '76561199447292025', '76561199447723992', '76561199447915409',
    '76561199146597603', '76561199447535703', '76561199175603735', '76561199046699102', '76561199183725960',
    '76561199446852465', '76561199155697221', '76561199137576389', '76561199177662569', '76561199004450321',
    '76561199184124370', '76561199447243245', '76561199173989116', '76561199447853345', '76561199183360237',
    '76561199447467553', '76561199447292025', '76561199447915409', '76561199447723992', '76561199155697221',
    '76561199137576389', '76561199175603735', '76561199446852465', '76561199046699102', '76561199004450321',
    '76561199184124370', '76561199447243245', '76561199177662569', '76561199447853345', '76561199183725960',
    '76561199173989116', '76561199129370686', '76561199066642365', '76561199183360237', '76561199183576429',
    '76561198006256853', '76561199155073325', '76561199047982923', '76561199181726161', '76561199164664539',
    '76561199175614827', '76561199153870475', '76561199174098111', '76561199159456530', '76561199181988722',
    '76561199392311591', '76561199436368477', '76561199394469379', '76561199081105533', '76561199434991248',
    '76561199436042130', '76561199436219526', '76561199434985625', '76561199127109757', '76561199447007388',
    '76561199127109757', '76561199391239876', '76561199144445066', '76561199194831852', '76561199392074983',
    '76561199404934517', '76561199435479585', '76561199391904927', '76561199187713698', '76561199183994422',
    '76561199195868071', '76561199126448864', '76561199020181454', '76561199092253366', '76561198995684062',
    '76561199150664454', '76561199170421473', '76561199151544690', '76561199018884352', '76561199190083700',
    '76561199195868071', '76561199192099609', '76561199194572754', '76561199149709285', '76561199436483504',
    '76561199128108337', '76561199392075340', '76561199393324475', '76561199152570785', '76561199190083700',
    '76561199001746615', '76561199018884352', '76561199151544690', '76561199391195723', '76561199190223612',
    '76561199392074983', '76561199189551091', '76561199092253366', '76561198995684062', '76561199150664454',
    '76561199393324475', '76561199190083700', '76561199389303494', '76561199189551091', '76561199126028468',
    '76561199190102141', '76561199133275996', '76561199392074983', '76561199144445066', '76561199178489030', 
    '76561199545636357', '76561199545096013', '76561199545512668', '76561199545676649', '76561199417852787',
    '76561199417100391', '76561199447923059','76561199435896666', '76561199147423823', '76561199403989609', 
    '76561199447623649', '76561199447504306', '76561199447362718', '76561199447402644', '76561199166447096',
    '76561199392682403', '76561198990326951', '76561199107673906', '76561199392057330', '76561199190037539',
    '76561199150084275', '76561199185499208', '76561199168873028', '76561199404375885','76561199447710824',
    '76561199079509984', '76561199168873028', '76561199195620180', '76561199006157229', '76561199421669310',
    '76561199420375192', '76561199545753076', '76561199544429762', '76561199545774489', '76561199545170592',
    '76561199419271460', '76561199545866635', '76561199545515803', '76561199544992734', '76561199544702964',
    '76561199418044935', '76561199544454536', '76561199545938351', '76561199418495813', '76561199545324753',
    '76561199544454536', '76561199418044935', '76561199545938351', '76561199420026024', '76561199545980733',
    '76561199418495813', '76561199545263840', '76561199417817939', '76561199545746594', '76561199544979852',
    '76561199417789326', '76561199545538800', '76561199418868960', '76561199545324753', '76561199545942049',
    '76561199447336682', '76561199447013231', '76561199447399467', '76561199447614170', '76561199447553399',
    '76561199543855519', '76561199418056704', '76561199545184827', '76561199417169423', '76561199419750156',
    '76561199545610172', '76561199545721837', '76561199544756210', '76561199419095648', '76561199419999357',
    '76561199415547142', '76561199545309015', '76561199418065930', '76561199544736925', '76561199418421404',
    '76561199417662184', '76561199417906909', '76561199418336567', '76561199420588594', '76561199545037701',
    '76561199544736925', '76561199418065930', '76561199418421404', '76561199417662184', '76561199417988248',
    '76561199417906909', '76561199418336567', '76561199420473539', '76561199545198648', '76561199419570722',
    '76561199417041765', '76561199545666083', '76561199545268475', '76561199544730342', '76561199417976629',
    '76561199417963837', '76561199545679271', '76561199404422145', '76561199546020072', '76561199544811842',
    '76561199419570722', '76561199420473539', '76561199417041765', '76561199545666083', '76561199545679271',
    '76561199418930658', '76561199545355100', '76561199419879443', '76561199544730342', '76561199419076158',
    '76561199546074111', '76561199417754542', '76561199421528441', '76561199544961499', '76561199545240327',
    '76561199545069123', '76561199545976994', '76561199419219332', '76561199421198982', '76561199545889248',
    '76561199419076158', '76561199421528441', '76561199546074111', '76561199421198982', '76561199418697561',
    '76561199419994126', '76561199418283611', '76561199189534703', '76561199420603941', '76561199417950884',
    '76561199544422684', '76561199545286078', '76561199545201839', '76561199404919817', '76561199544694301',
    '76561199545414185', '76561199544410981', '76561199545588994', '76561199419834226', '76561199418333872',
    '76561199544682949', '76561199417318679', '76561199417537827', '76561199544878108', '76561199421596177',
    '76561199419150699', '76561199545251412', '76561199545553683', '76561199545046289', '76561199418571280',
    '76561199545635776', '76561199544896574', '76561199545124897', '76561199545887093', '76561199418098758',
    '76561199419091543', '76561199544775546', '76561199545089115', '76561199545355891', '76561199545383332',
    '76561199545367639', '76561199544420956', '76561199546202227', '76561199544155719', '76561199545271059',
    '76561199545645638', '76561199546120122', '76561199545019645', '76561199545428241', '76561199545198666',
    '76561199419454048', '76561199418076497', '76561199420439372', '76561199545189861', '76561199417354620',
    '76561199417647312', '76561199418187247', '76561199545657199', '76561199544908647', '76561199545203082',
    '76561199420588185', '76561199544574349', '76561199417020016', '76561199545206304', '76561199545251927',
    '76561198104500554','76561199417514147','76561199166447096',
    
    
    '76561199739471682','76561198316214356', '76561198152164991','76561199130432162', '76561198998336799',
    '76561198177518099', '76561198316099005', '76561199153699291', '76561198962442004', '76561199158513643',
    '76561198428602113', '76561198851682743', '76561199042501924', '76561199200722569', '76561199087530915',
    '76561198998336799', '76561199512360555', '76561199274658372', '76561199411101472', '76561199267899723',
    '76561199355814480', '76561199401885071', '76561199441598842', '76561199429208869', '76561199507071195',
    '76561198164398573', '76561199743285385', '76561199609399591', '76561199659795885', '76561199741595427',
    '76561199741595427', '76561199609399591', '76561199743285385', '76561199569830148', '76561199575547886',
    '76561199547487836', '76561199737055343', '76561199798866508', '76561199745703756', '76561199545778621',
    '76561199633754533', '76561199556576926', '76561199693902512', '76561199801379195', '76561199548351838',
    '76561199794294400', '76561199730414920', '76561199691840168', '76561199612593809', '76561199111510750',
    '76561199226390061', '76561199163215334', '76561199043992578', '76561198054013153', '76561198369794877',
    '76561199728241404', '76561199750146422', '76561199577315556', '76561199697794898', '76561199731235035',
    '76561199014233742', '76561199071203238', '76561199084801539', '76561199041913550', '76561199275679989',
    '76561199052765228', '76561199054603822', '76561199227675061', '76561199183430682','76561198996772569',
    '76561199744784785', '76561199549340844', '76561199518029572', '76561199507265913', '76561199507686624',
    '76561199511731414', '76561199039963196', '76561198181735917', '76561198243358794', '76561199230002378',
    '76561199480503022', '76561199495055957', '76561199507574015', '76561199438001777', '76561199549837249',
    '76561199604388314', '76561199627369933', '76561199641315402', '76561199531105087', '76561199681416925',
    '76561199686210502', '76561199364564507', '76561199549105881', '76561199757115215', '76561199406429950',
    '76561199650289322', '76561199403011837', '76561198883152807', '76561198262789010', '76561199719650650',
    '76561198997740713', '76561199692887290', '76561199097831050', '76561199082919789', '76561199149057307',
    '76561199037709758', '76561199614618964', '76561198013547155','76561198311585018', '76561199208284228',
    '76561199686597220', '76561199521058194', '76561199238947372', '76561199706773850', '76561199525196209',
    '76561199232331866', '76561199078524700', '76561199403789575','76561199769694358', '76561199614846072',
    '76561199433227118','76561199036162775', '76561198872598024', '76561198294247284','76561198382518822',
    '76561199569830148', '76561199548092103', '76561199143350957','76561199083303181','76561199506894148',
    '76561199406269446','76561199205193719', '76561199569161430','76561199545220637','76561199569767133',
    '76561199590722711', '76561199582889175', '76561199507200612', '76561199047042187','76561199445525515', 
    '76561199170768162', '76561199093729892', '76561199186121245', '76561199227691961','76561199220921533',
    '76561199507381446','76561199195683959','76561199183343351', '76561199323497804', '76561199077528514',
    '76561199589823074', '76561199058853128','76561199072980252', 

]

DATA_FILE = 'friend_data.json'
INIT_FILE = '.initialized'

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger("SteamFriendIDMonitor")

def get_profile_link(steam_id):
    """Generate Steam profile link from Steam ID"""
    return f"steamcommunity.com/profiles/{steam_id}"

async def fetch_friend_list(session, steam_id):
    """Fetch the complete friend list for a Steam account"""
    url = f"http://api.steampowered.com/ISteamUser/GetFriendList/v0001/?key={STEAM_API_KEY}&steamid={steam_id}&relationship=friend"
    profile_link = get_profile_link(steam_id)
    
    try:
        async with session.get(url, timeout=10) as resp:
            if resp.status == 200:
                data = await resp.json()
                friends_data = data.get('friendslist', {}).get('friends', [])
                # Extract just the Steam IDs of friends
                friend_ids = [friend['steamid'] for friend in friends_data]
                return steam_id, profile_link, friend_ids
            elif resp.status == 403:
                logger.warning(f"{profile_link} is private")
                return steam_id, profile_link, None
            else:
                logger.error(f"{profile_link}: API error {resp.status}")
                return steam_id, profile_link, None
    except Exception as e:
        logger.error(f"Error fetching {profile_link}: {e}")
        return steam_id, profile_link, None

async def send_telegram_message(message):
    """Send message to Telegram, splitting if too long"""
    MAX_MESSAGE_LENGTH = 4000  # Leave some buffer under 4096 limit
    
    if len(message) <= MAX_MESSAGE_LENGTH:
        await _send_single_message(message)
    else:
        # Split message into chunks
        lines = message.split('\n')
        current_chunk = ""
        
        for line in lines:
            # If adding this line would exceed limit, send current chunk
            if len(current_chunk + line + '\n') > MAX_MESSAGE_LENGTH:
                if current_chunk:
                    await _send_single_message(current_chunk.strip())
                    current_chunk = line + '\n'
                else:
                    # Single line is too long, truncate it
                    await _send_single_message(line[:MAX_MESSAGE_LENGTH])
            else:
                current_chunk += line + '\n'
        
        # Send remaining chunk
        if current_chunk:
            await _send_single_message(current_chunk.strip())

async def _send_single_message(message):
    """Send a single message to Telegram"""
    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"
    payload = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': message,
        'parse_mode': 'HTML'
    }
    async with aiohttp.ClientSession() as session:
        try:
            async with session.post(url, data=payload) as resp:
                if resp.status != 200:
                    logger.error(f"Failed to send message: {await resp.text()}")
                else:
                    logger.info("Telegram message sent successfully")
        except Exception as e:
            logger.error(f"Telegram error: {e}")

def load_previous_data():
    """Load previous friend data from file"""
    try:
        with open(DATA_FILE, 'r') as f:
            return json.load(f)
    except:
        return {}

def save_data(data):
    """Save friend data to file"""
    with open(DATA_FILE, 'w') as f:
        json.dump(data, f, indent=2)

def is_first_run():
    """Check if this is the first run of the bot"""
    if os.path.exists(INIT_FILE):
        return False
    with open(INIT_FILE, 'w') as f:
        f.write(datetime.now().isoformat())
    return True

async def check_accounts():
    """Main function to check all accounts for friend changes"""
    first_run = is_first_run()
    previous_data = load_previous_data()
    current_data = {}
    all_new_friends = []  # Collect all new friends for batched notification
    
    async with aiohttp.ClientSession() as session:
        tasks = [fetch_friend_list(session, steam_id) for steam_id in STEAM_ACCOUNTS]
        results = await asyncio.gather(*tasks)

    for steam_id, profile_link, friend_ids in results:
        if friend_ids is None:
            continue
            
        current_data[steam_id] = {
            'profile_link': profile_link,
            'friends': friend_ids,
            'count': len(friend_ids)
        }
        
        # Skip change detection on first run
        if first_run or steam_id not in previous_data:
            continue
            
        previous_friends = set(previous_data[steam_id].get('friends', []))
        current_friends = set(friend_ids)
        
        # Check for new friends only
        new_friends = current_friends - previous_friends
        if new_friends:
            for friend_id in new_friends:
                friend_profile_link = get_profile_link(friend_id)
                all_new_friends.append(friend_profile_link)
                logger.info(f"New friend detected: {friend_id} added to {steam_id}")
        
        # Log removed friends (no telegram notification)
        removed_friends = previous_friends - current_friends
        if removed_friends:
            for friend_id in removed_friends:
                logger.info(f"Friend removed: {friend_id} removed from {steam_id}")

    # Send batched notification for all new friends
    logger.info(f"Total new friends collected: {len(all_new_friends)}")
    logger.info(f"First run status: {first_run}")
    
    if all_new_friends and not first_run:
        if len(all_new_friends) == 1:
            msg = f"New friend: {all_new_friends[0]}"
        else:
            msg = f"New friends detected ({len(all_new_friends)}):\n\n"
            msg += "\n".join([f"• {friend_link}" for friend_link in all_new_friends])
        
        logger.info(f"Attempting to send Telegram message: {msg[:100]}...")
        await send_telegram_message(msg)
        logger.info(f"Sent batched notification for {len(all_new_friends)} new friends")
    elif all_new_friends and first_run:
        logger.info(f"New friends detected on first run (not sending notification): {len(all_new_friends)}")
    else:
        logger.info("No new friends detected in this cycle")

    # Save current data
    save_data(current_data)

    if first_run:
        # Log initial setup (no telegram messages)
        total_accounts = len(current_data)
        private_accounts = len(STEAM_ACCOUNTS) - total_accounts
        total_friends = sum(data['count'] for data in current_data.values())
        
        logger.info(f"Steam Friend ID Monitor Setup Complete")
        logger.info(f"Monitoring {total_accounts} accounts")
        logger.info(f"Total friends being tracked: {total_friends}")
        if private_accounts > 0:
            logger.info(f"{private_accounts} accounts are private")
        logger.info("Bot will now notify when specific friends are added with their Steam IDs")
    else:
        logger.info("Friend check completed")

if __name__ == '__main__':
    asyncio.run(check_accounts())
